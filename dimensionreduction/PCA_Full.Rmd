---
title: "Outcome Selection (Full): Group A and B"
author: "Shannon Holcroft"
format: html
---

Both time and the variables of interest are reference coded. The time effect describes the average change over time for the reference group (or if two patients were compared, holding the variable of interest constant). The variable of interest effect is then expressed as deviations from the trajectory of the reference group. 

Looking at time-variable interactions gives you the level differences in within-level changes (i.e. the level effect) from baseline to each time point, expressing these differences as deviations from the general time effect.

```{r}
library(tidyverse)
library(reshape2)
library(factoextra)
library(ggpubr)
library(cluster)
library(ggdendro)

```

## Data Preparation

Read in the data extracted from the fitted GLMMs for each group and variable of interest.

```{r, echo=FALSE}

# Read in combined data

alldat = read.csv("combined_data.csv")[-1]

# Drop very infrequently observed immune outcomes, antibody titres and assays

droplist = c("%CD8+ totIL17+", "%CD8+ totIL2+", "%CD8+ totIL22+", "Baby Anti-BCG IgA (AUC)", "Baby Anti-BCG IgM (AUC)", "Baby Anti-BCG IgG (AUC)", "Elispot (BCG)")

alldat = alldat[-which(alldat$Outcome %in% droplist), ]

# Change names for display for certain immune outcomes

namelist = c("bulk CD8+/% R7-RA-", "bulk CD8+/% R7-RA+", "bulk CD8+/% R7+RA-", "bulk CD8+/% R7+RA+", "CD8+ ANYcytok+")
namechange = c("Bulk CD8+/% R7-RA-", "Bulk CD8+/% R7-RA+", "Bulk CD8+/% R7+RA-", "Bulk CD8+/% R7+RA+", "%CD8+ ANYcytok+")

alldat = alldat %>% mutate(Outcome = if_else(Outcome %in% namelist, recode(Outcome, !!!setNames(namechange, namelist)), Outcome))

# Separate into Group A and Group B

datA = alldat %>% filter(Arm == "A")
allA = unique(datA$Outcome)

datB = alldat %>% filter(Arm == "B")
allB = unique(datB$Outcome)

# Separate by variables of interest

dat1A = datA %>% filter(Group == "MVA85A") %>% filter(Coefficient %in% c("TreatmentMVA85A", "TreatmentMVA85A:Time56", "TreatmentMVA85A:Time365"))
dat1B = datB %>% filter(Group == "MVA85A") %>% filter(Coefficient %in% c("TreatmentMVA85A", "TreatmentMVA85A:Time56", "TreatmentMVA85A:Time365"))

dat2A = datA %>% filter(Group == "QFT") %>% filter(Coefficient %in% c("QFTPositive", "QFTPositive:Time56", "QFTPositive:Time365"))
dat2B = datB %>% filter(Group == "QFT") %>% filter(Coefficient %in% c("QFTPositive", "QFTPositive:Time56", "QFTPositive:Time365"))

dat3A = datA %>% filter(Group %in% c("FA - FA", "FA - BA"))

# Retain specific comparisons of interest: FA0 in FA-BA, FA1 in FA-FA, FA2 in FA-FA, FA3 in FA-BA

dat3.1.1A = dat3A %>% filter(Group == "FA - FA") %>% filter(Coefficient %in% c("FA1", "FA3", "FA1:Time56", "FA1:Time365", "FA3:Time56", "FA3:Time365", "FA1:Time63", "FA3:Time63"))
dat3.1.2A = dat3A %>% filter(Group == "FA - BA") %>% filter(Coefficient %in% c("FA0", "FA2", "FA0:Time56", "FA2:Time56", "FA2:Time365",  "FA0:Time365", "FA0:Time63","FA2:Time63"))
      
dat3A = rbind(dat3.1.1A, dat3.1.2A)

dat3B = datB %>% filter(Group %in% c("FA - FA", "FA - BA"))

# Retain specific comparisons of interest: FA0 in FA-BA, FA1 in FA-FA, FA2 in FA-FA, FA3 in FA-BA

dat3.1.1B = dat3B %>% filter(Group == "FA - FA") %>% filter(Coefficient %in% c("FA1", "FA3", "FA1:Time56", "FA1:Time365", "FA3:Time56", "FA3:Time365", "FA1:Time63", "FA3:Time63"))
dat3.1.2B = dat3B %>% filter(Group == "FA - BA") %>% filter(Coefficient %in% c("FA0", "FA2", "FA0:Time56", "FA2:Time56", "FA2:Time365",  "FA0:Time365", "FA0:Time63","FA2:Time63"))
      
dat3B = rbind(dat3.1.1B, dat3.1.2B)

dat4A = datA %>% filter(Coefficient %in% c("GenderM", "Time56:GenderM", "Time365:GenderM"))
dat4B = datB %>% filter(Coefficient %in% c("GenderM", "Time56:GenderM", "Time365:GenderM"))
```

Create data frames for PCA

```{r}
# Create long format data frames for groups A and B

tmelt_1A = melt(dat1A) %>% filter(variable == "EstOverSE")
tmelt_2A = melt(dat2A) %>% filter(variable == "EstOverSE")
tmelt_3A = melt(dat3A) %>% filter(variable == "EstOverSE")
tmelt_4A = melt(dat4A) %>% filter(variable == "EstOverSE")

tmelt_1B = melt(dat1B) %>% filter(variable == "EstOverSE")
tmelt_2B = melt(dat2B) %>% filter(variable == "EstOverSE")
tmelt_3B = melt(dat3B) %>% filter(variable == "EstOverSE")
tmelt_4B = melt(dat4B) %>% filter(variable == "EstOverSE")

```

## Make some heat maps to visualize what we're putting into the PCA

```{r}

ggplot(tmelt_1A, aes(x = Coefficient, y = reorder(Outcome, value), fill = value)) +
  geom_tile(color = "black") +
  theme(axis.text.y = element_text(size=5), axis.text.x = element_text(size=7, angle = 90), axis.title.y = element_blank(), axis.title.x = element_blank(), legend.title = element_blank()) +
  scale_fill_gradient2(low = "#075AFF",
                       mid = "white",
                       high = "#FF0000") + coord_fixed()

ggplot(tmelt_2A, aes(x = Coefficient, y = reorder(Outcome, value), fill = value)) +
  geom_tile(color = "black") +
  theme(axis.text.y = element_text(size=5), axis.text.x = element_text(size=7, angle = 90), axis.title.y = element_blank(), axis.title.x = element_blank(), legend.title = element_blank()) +
  scale_fill_gradient2(low = "#075AFF",
                       mid = "white",
                       high = "#FF0000") + coord_fixed()

ggplot(tmelt_3A, aes(x = Coefficient, y = reorder(Outcome, value), fill = value)) +
  geom_tile(color = "black") +
  theme(axis.text.y = element_text(size=5), axis.text.x = element_text(size=7, angle = 90), axis.title.y = element_blank(), axis.title.x = element_blank(), legend.title = element_blank()) +
  scale_fill_gradient2(low = "#075AFF",
                       mid = "white",
                       high = "#FF0000") + coord_fixed()

ggplot(tmelt_4A, aes(x = Coefficient, y = reorder(Outcome, value), fill = value)) +
  geom_tile(color = "black") +
  theme(axis.text.y = element_text(size=5), axis.text.x = element_text(size=7, angle = 90), axis.title.y = element_blank(), axis.title.x = element_blank(), legend.title = element_blank()) +
  scale_fill_gradient2(low = "#075AFF",
                       mid = "white",
                       high = "#FF0000") + coord_fixed()

ggplot(tmelt_1B, aes(x = Coefficient, y = reorder(Outcome, value), fill = value)) +
  geom_tile(color = "black") +
  theme(axis.text.y = element_text(size=5), axis.text.x = element_text(size=7, angle = 90), axis.title.y = element_blank(), axis.title.x = element_blank(), legend.title = element_blank()) +
  scale_fill_gradient2(low = "#075AFF",
                       mid = "white",
                       high = "#FF0000") + coord_fixed()

ggplot(tmelt_2B, aes(x = Coefficient, y = reorder(Outcome, value), fill = value)) +
  geom_tile(color = "black") +
  theme(axis.text.y = element_text(size=5), axis.text.x = element_text(size=7, angle = 90), axis.title.y = element_blank(), axis.title.x = element_blank(), legend.title = element_blank()) +
  scale_fill_gradient2(low = "#075AFF",
                       mid = "white",
                       high = "#FF0000") + coord_fixed()

ggplot(tmelt_3B, aes(x = Coefficient, y = reorder(Outcome, value), fill = value)) +
  geom_tile(color = "black") +
  theme(axis.text.y = element_text(size=5), axis.text.x = element_text(size=7, angle = 90), axis.title.y = element_blank(), axis.title.x = element_blank(), legend.title = element_blank()) +
  scale_fill_gradient2(low = "#075AFF",
                       mid = "white",
                       high = "#FF0000") + coord_fixed()

ggplot(tmelt_4B, aes(x = Coefficient, y = reorder(Outcome, value), fill = value)) +
  geom_tile(color = "black") +
  theme(axis.text.y = element_text(size=5), axis.text.x = element_text(size=7, angle = 90), axis.title.y = element_blank(), axis.title.x = element_blank(), legend.title = element_blank()) +
  scale_fill_gradient2(low = "#075AFF",
                       mid = "white",
                       high = "#FF0000") + coord_fixed()
```

## Principal Component Analysis

## MVA85A

Apply PCA to standardised regression coefficients for MVA85A and interactions between MVA85A and time points. In Group A, the first PCs explains sufficient variance in the standardised regression coefficients. 

```{r}

pca1.2A = tmelt_1A[, c("Outcome", "Coefficient", "value")]

# Restructure the data frame

pca1.2A = pca1.2A %>%
  distinct(Outcome, Coefficient, .keep_all = TRUE)

pca1.2A_wide = pca1.2A %>%
  pivot_wider(names_from = Coefficient, id_cols = Outcome, values_from = value)

pca1.2A_mat = as.matrix(pca1.2A_wide[, 2:4], nrow = nrow(pca1.2A_wide), ncol = 3)
rownames(pca1.2A_mat) = pca1.2A_wide$Outcome
str(pca1.2A_mat)

pca1.2Ares = princomp(pca1.2A_mat, cor = TRUE, scores = TRUE)
summary(pca1.2Ares) # Component 1 should suffice

fviz_eig(pca1.2Ares, addlabels = TRUE, barfill = "darkgrey", barcolor = "black", bar_width = 0.5,
         xlab = "\n Number of Principal Components", ylab = "Variance Explained (%)\n", main = "",
         ylim = c(0, 100)) + theme_minimal() +
theme(axis.title.y = element_text(size = 12, family = "Arial", face = "bold"),
                                   axis.title.x = element_text(size = 12, family = "Arial", face = "bold"),
                                   axis.text.x = element_text(size = 10, family = "Arial"),
                                   axis.text.y = element_text(size = 10, family = "Arial"))


```

PC1 primarily describes Day 56 with Day 112 as the reference point and MVA85A priming at Day 365. 
```{r}
fviz_contrib(pca1.2Ares, axes = 1, choice = "var", fill = "darkgrey", color = "black", top = 10) +
  labs(y = element_text("Contributions(%)\n")) +
  theme_minimal() +
  theme(title = element_blank(),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 10, angle = 45, vjust = 1, hjust = 1),
        axis.text.y = element_text(size = 10))
```

9 immune outcomes score more highly than the uniform expectation on PC1. 
```{r}
fviz_contrib(pca1.2Ares, axes = 1, choice = "ind", fill = "darkgrey", color = "black", top = 10) +
  labs(y = element_text("Contributions(%)\n")) +
  theme_minimal() +
  theme(title = element_blank(),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 10, angle = 45, vjust = 1, hjust = 1),
        axis.text.y = element_text(size = 10))
```

They are selected to a subset.

```{r}
contrib1.2A.1 = fviz_contrib(pca1.2Ares, axes = 1, choice = "ind")

pc1dat = contrib1.2A.1$data[which(contrib1.2A.1$data$contrib >= 3), ]

pcnames1 = as.character(unique(c(pc1dat$name)))

mva_pca_set = pcnames1

```

## QFT

Apply PCA to standardised regression coefficients for QFT+ and interactions between QFT+ and time points. In Group A, 1 PC is sufficient.

```{r}

pca2.2A = tmelt_2A[, c("Outcome", "Coefficient", "value")]

# Restructure the data frame

pca2.2A = pca2.2A %>%
  distinct(Outcome, Coefficient, .keep_all = TRUE)

pca2.2A_wide = pca2.2A %>%
  pivot_wider(names_from = Coefficient, id_cols = Outcome, values_from = value)

pca2.2A_mat = as.matrix(pca2.2A_wide[, 2:4], nrow = nrow(pca2.2A_wide), ncol = 3)
rownames(pca2.2A_mat) = pca2.2A_wide$Outcome
str(pca2.2A_mat)

pca2.2Ares = princomp(pca2.2A_mat, cor = TRUE, scores = TRUE)
summary(pca2.2Ares) # Component 1 should suffice

fviz_eig(pca2.2Ares, addlabels = TRUE, barfill = "darkgrey", barcolor = "black", bar_width = 0.5,
         xlab = "\n Number of Principal Components", ylab = "Variance Explained (%)\n", main = "",
         ylim = c(0, 100)) + theme_minimal() +
theme(axis.title.y = element_text(size = 12, family = "Arial", face = "bold"),
                                   axis.title.x = element_text(size = 12, family = "Arial", face = "bold"),
                                   axis.text.x = element_text(size = 10, family = "Arial"),
                                   axis.text.y = element_text(size = 10, family = "Arial"))

```

PC1 primarily describes QFT 8 weeks after BCG.

```{r}

fviz_contrib(pca2.2Ares, axes = 1, choice = "var", fill = "darkgrey", color = "black", top = 10) +
  labs(y = element_text("Contributions(%)\n")) +
  theme_minimal() +
  theme(title = element_blank(),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 10, angle = 45, vjust = 1, hjust = 1),
        axis.text.y = element_text(size = 10))


```
There are 11 contributing immune outcomes.

```{r}
fviz_contrib(pca2.2Ares, axes = 1, choice = "ind", fill = "darkgrey", color = "black", top = 15) +
  labs(y = element_text("Contributions(%)\n")) +
  theme_minimal() +
  theme(title = element_blank(),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 10, angle = 45, vjust = 1, hjust = 1),
        axis.text.y = element_text(size = 10))

```

```{r}
contrib2.2A.1 = fviz_contrib(pca2.2Ares, axes = 1, choice = "ind")

pc1dat = contrib2.2A.1$data[which(contrib2.2A.1$data$contrib >= 3), ]

pcnames1 = as.character(unique(c(pc1dat$name)))
#pcnames2 = as.character(unique(c(pc1dat$name)))

qft_pca_set = pcnames1

```

Perform PCA on FA coefficients. Two PCs should be analysed.

```{r}
mat3.2A = tmelt_3A[, c("Outcome", "Coefficient", "value")]

# Restructure the data frame

pca3.2A = mat3.2A %>%
  distinct(Outcome, Coefficient, .keep_all = TRUE)

pca3.2A_wide = pca3.2A %>%
  pivot_wider(names_from = Coefficient, id_cols = Outcome, values_from = value)

pca3.2A_mat = as.matrix(pca3.2A_wide[, 2:9], nrow = nrow(pca3.2A_wide), ncol = 8)
rownames(pca3.2A_mat) = pca3.2A_wide$Outcome

pca3.2Ares = princomp(pca3.2A_mat, cor = TRUE, scores = TRUE)
summary(pca3.2Ares) # Component 1 should suffice

fviz_eig(pca3.2Ares, addlabels = TRUE, barfill = "darkgrey", barcolor = "black", bar_width = 0.5,
         xlab = "\n Number of Principal Components", ylab = "Variance Explained (%)\n", main = "",
         ylim = c(0, 100)) + theme_minimal() +
theme(axis.title.y = element_text(size = 12, family = "Arial", face = "bold"),
                                   axis.title.x = element_text(size = 12, family = "Arial", face = "bold"),
                                   axis.text.x = element_text(size = 10, family = "Arial"),
                                   axis.text.y = element_text(size = 10, family = "Arial"))
```

PC1 primarily describes FA3. PC2 primarily described FA1.

```{r}

fviz_contrib(pca3.2Ares, axes = 1, choice = "var", fill = "darkgrey", color = "black", top = 10) +
  labs(y = element_text("Contributions(%)\n")) +
  theme_minimal() +
  theme(title = element_blank(),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 10, angle = 45, vjust = 1, hjust = 1),
        axis.text.y = element_text(size = 10))

fviz_contrib(pca3.2Ares, axes = 2, choice = "var", fill = "darkgrey", color = "black", top = 10) +
  labs(y = element_text("Contributions(%)\n")) +
  theme_minimal() +
  theme(title = element_blank(),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 10, angle = 45, vjust = 1, hjust = 1),
        axis.text.y = element_text(size = 10))


```

PC1 has 8 contributing outcomes. PC2 has 11 contributing outcomes.

```{r}

fviz_contrib(pca3.2Ares, axes = 1, choice = "ind", fill = "darkgrey", color = "black", top = 15) +
  labs(y = element_text("Contributions(%)\n")) +
  theme_minimal() +
  theme(title = element_blank(),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 10, angle = 45, vjust = 1, hjust = 1),
        axis.text.y = element_text(size = 10))

fviz_contrib(pca3.2Ares, axes = 2, choice = "ind", fill = "darkgrey", color = "black", top = 15) +
  labs(y = element_text("Contributions(%)\n")) +
  theme_minimal() +
  theme(title = element_blank(),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 10, angle = 45, vjust = 1, hjust = 1),
        axis.text.y = element_text(size = 10))

```

The combined set contains 15 immune outcomes.

```{r}
contrib3.2A.1 = fviz_contrib(pca3.2Ares, axes = 1, choice = "ind")
contrib3.2A.2 = fviz_contrib(pca3.2Ares, axes = 2, choice = "ind")

pc1dat = contrib3.2A.1$data[which(contrib3.2A.1$data$contrib >= 3), ]
pc2dat = contrib3.2A.2$data[which(contrib3.2A.2$data$contrib >= 3), ]

pcnames1 = as.character(unique(c(pc1dat$name, pc2dat$name)))

fa_pca_set = pcnames1

```

Assuming that the subsets are independent, we can perform corrections within subsets. Retrieve the fitted models by VOI.

```{r}
# MVA85A 

AM_1.1 = glmmTMB(O4 ~ Treatment*Time + Gender*Time + (1| ID), data = groupA, family = tweedie(link = "log"))
AS_1.1 = summary(AM_1.1)

AM_1.2 =glmmTMB(O17 ~ Treatment*Time + Gender*Time + (1| ID), data = groupA, family = Gamma(link = "log"))
AS_1.2 = summary(AM_1.2)

AM_1.3 =glmmTMB(O20 ~ Treatment*Time + Gender*Time + (1| ID), data = groupA, family = tweedie(link = "log"))
AS_1.3 = summary(AM_1.3)

AM_1.4 = glmmTMB(O31 ~ Treatment*Time + Gender*Time + (1| ID), data = groupA, family = poisson(link = "log"))
AS_1.4 = summary(AM_1.4)

AM_1.5 = glmmTMB(O27 ~ Treatment*Time + Gender*Time + (1| ID), data = groupA, family = tweedie(link = "log"))
AS_1.5 = summary(AM_1.5)

AM_1.6 = glmmTMB(O25 ~ Treatment*Time + Gender*Time + (1| ID), data = groupA, family = tweedie(link = "log"))
AS_1.6 = summary(AM_1.6)

AM_1.7 = glmmTMB(94-O15 ~ Treatment*Time + Gender*Time + (1| ID), data = groupA, family = tweedie(link = "log"))
AS_1.7 = summary(AM_1.7)

AM_1.8 = glmmTMB(101 - O19 ~ Treatment*Time + Gender*Time + (1| ID), data = groupA, family = Gamma(link = "log"))
AS_1.8 = summary(AM_1.8)

AM_1.9 = glmmTMB(101 - O36 ~ Treatment*Time + Gender*Time + (1| ID), data = groupA, family = tweedie(link = "log"))
AS_1.9 = summary(AM_1.9)

n1 = length(mva_pca_set)
v1.1 = varA[4]
v1.2 = varA[17]
v1.3 = varA[31]
v1.5 = varA[27]
v1.6 = varA[25]
v1.7 = varA[15]
v1.8 = varA[19]
v1.9 = varA[36]

```

Create a contrast matrix for the predetermined pairwise comparisons.

```{r}

# Extract combinations of the levels

combinations = data.frame(emmeans(AM_1.1, ~ Treatment * Time))
combination_names = paste(combinations$Treatment, combinations$Time, sep = "_")

# Define the list of contrasts

contrast_list = list(
  
  # Comparisons within Control
  
  "Control_T2_vs_T1" = setNames(c(1, 0, -1, 0, 0, 0), combination_names),
  "Control_T2_vs_T3" = setNames(c(1, 0, 0, 0, -1, 0), combination_names),
  "Control_T1_vs_T3" = setNames(c(0, 0, 1, 0, -1, 0), combination_names),
  
  # Comparisons within MVA85A
  
  "MVA85A_T2_vs_T1" = setNames(c(0, 1, 0, -1, 0, 0), combination_names),
  "MVA85A_T2_vs_T3" = setNames(c(0, 1, 0, 0, 0, -1), combination_names),
  "MVA85A_T1_vs_T3" = setNames(c(0, 0, 0, 1, 0, -1), combination_names),
  
  # Comparisons between Control and MVA85A
  
  "T2_Control_vs_MVA85A" = setNames(c(1, -1, 0, 0, 0, 0), combination_names),
  "T1_Control_vs_MVA85A" = setNames(c(0, 0, 1, -1, 0, 0), combination_names),
  "T3_Control_vs_MVA85A" = setNames(c(0, 0, 0, 0, 1, -1), combination_names)
)

contrast_list
```

Estimate and apply corrections for MVA85A priming. Only significant differences within group over time.
```{r}

emm1.1 = emmeans(AM_1.1, ~ Treatment * Time)
emm1.2 = emmeans(AM_1.2, ~ Treatment * Time)
emm1.3 = emmeans(AM_1.3, ~ Treatment * Time)
emm1.4 = emmeans(AM_1.4, ~ Treatment * Time)
emm1.5 = emmeans(AM_1.5, ~ Treatment * Time)
emm1.6 = emmeans(AM_1.6, ~ Treatment * Time)
emm1.7 = emmeans(AM_1.7, ~ Treatment * Time)
emm1.8 = emmeans(AM_1.8, ~ Treatment * Time)
emm1.9 = emmeans(AM_1.9, ~ Treatment * Time)

# Apply custom contrasts
contrasts1.1 = data.frame(contrast(emm1.1, method = contrast_list, adjust = "none"))
contrasts1.2 = data.frame(contrast(emm1.2, method = contrast_list, adjust = "none"))
contrasts1.3 = data.frame(contrast(emm1.3, method = contrast_list, adjust = "none"))
contrasts1.4 = data.frame(contrast(emm1.4, method = contrast_list, adjust = "none"))
contrasts1.5 = data.frame(contrast(emm1.5, method = contrast_list, adjust = "none"))
contrasts1.6 = data.frame(contrast(emm1.6, method = contrast_list, adjust = "none"))
contrasts1.7 = data.frame(contrast(emm1.7, method = contrast_list, adjust = "none"))
contrasts1.8 = data.frame(contrast(emm1.8, method = contrast_list, adjust = "none"))
contrasts1.9 = data.frame(contrast(emm1.9, method = contrast_list, adjust = "none"))

contrasts1.1$Outcome = v1.1
contrasts1.2$Outcome = v1.2
contrasts1.3$Outcome = v1.3
contrasts1.4$Outcome = v1.4
contrasts1.5$Outcome = v1.5
contrasts1.6$Outcome = v1.6
contrasts1.7$Outcome = v1.7
contrasts1.8$Outcome = v1.8
contrasts1.9$Outcome = v1.9

mvapcares = rbind(contrasts1.1, contrasts1.2, contrasts1.3, contrasts1.4,
                  contrasts1.5, contrasts1.6, contrasts1.7, contrasts1.8, contrasts1.9)
mvapcares = mvapcares %>% arrange(p.value)

mvapcares$BH = p.adjust(mvapcares$p.value, method = "BH", n = length(mvapcares$p.value))
mvapcares$BY = p.adjust(mvapcares$p.value, method = "BY", n = length(mvapcares$p.value))

mvapcares$expestimate = exp(mvapcares$estimate)

mvapcares %>% filter(BH < 0.06) %>% filter(Outcome == v1.1)

mvapcares %>% filter(BH < 0.06) %>% filter(Outcome == v1.2)

mvapcares %>% filter(BH < 0.06) %>% filter(Outcome == v1.3)

mvapcares %>% filter(BH < 0.06) %>% filter(Outcome == v1.4)

mvapcares %>% filter(BH < 0.06) %>% filter(Outcome == v1.5)

mvapcares %>% filter(BH < 0.06) %>% filter(Outcome == v1.6)

mvapcares %>% filter(BH < 0.06) %>% filter(Outcome == v1.7)

mvapcares %>% filter(BH < 0.06) %>% filter(Outcome == v1.8)

mvapcares %>% filter(BH < 0.06) %>% filter(Outcome == v1.9)

```

```{r}
# QFT

qft_pca_set

AM_2.1 = glmmTMB(O13 ~ QFT*Time + Gender*Time + (1| ID), data = groupA, family = tweedie(link = "log"))
AS_2.1 = summary(AM_2.1)

AM_2.2 = glmmTMB(O16 ~ QFT*Time + Gender*Time + (1| ID), data = groupA, family = Gamma(link = "log"))
AS_2.2 = summary(AM_2.2)

AM_2.3 = glmmTMB(O21 ~ QFT*Time + Gender*Time + (1| ID), data = groupA, family = Gamma(link = "log"))
AS_2.3 = summary(AM_2.3)

AM_2.4 = glmmTMB(O18 ~ QFT*Time + Gender*Time + (1| ID), data = groupA, family = Gamma(link = "log"))
AS_2.4 = summary(AM_2.4)

AM_2.5 = glmmTMB(O22 ~ QFT*Time + Gender*Time + (1| ID), data = groupA, family = tweedie(link = "log"))
AS_2.5 = summary(AM_2.5)

AM_2.6 = glmmTMB(O23 ~ QFT*Time + Gender*Time + (1| ID), data = groupA, family = tweedie(link = "log"))
AS_2.6 = summary(AM_2.6)

AM_2.7 = glmmTMB(O24 ~ QFT*Time + Gender*Time + (1| ID), data = groupA, family = tweedie(link = "log"))
AS_2.7 = summary(AM_2.7)

AM_2.8 = glmmTMB(O31 ~ QFT*Time + Gender*Time + (1| ID), data = groupA, family = tweedie(link = "log"))
AS_2.8 = summary(AM_2.8)

AM_2.9 = glmmTMB(O25 ~ QFT*Time + Gender*Time + (1| ID), data = groupA, family = tweedie(link = "log"))
AS_2.9 = summary(AM_2.9)

AM_2.10 = glmmTMB(O30 ~ QFT*Time + Gender*Time + (1| ID), data = groupA, family = tweedie(link = "log"))
AS_2.10 = summary(AM_2.10)

AM_2.11 = glmmTMB(101 - O36 ~ QFT*Time + Gender*Time + (1| ID), data = groupA, family = tweedie(link = "log"))
AS_2.11 = summary(AM_2.11)

n2 = length(qft_pca_set)

v2.1 = varA[13]
v2.2 = varA[16]
v2.3 = varA[21]
v2.4 = varA[18]
v2.5 = varA[22]
v2.6 = varA[23]
v2.7 = varA[24]
v2.8 = varA[31]
v2.9 = varA[25]
v2.10 = varA[30]
v2.11 = varA[36]

```

Create a contrast matrix for the predetermined pairwise comparisons.

```{r}

# Extract combinations of the levels

combinations = data.frame(emmeans(AM_2.1, ~ QFT * Time))
combination_names = paste(combinations$QFT, combinations$Time, sep = "_")

# Define the list of contrasts

contrast_list = list(
  
  # Comparisons within Negative
  
  "Negative_T2_vs_T1" = setNames(c(1, 0, -1, 0, 0, 0), combination_names),
  "Negative_T2_vs_T3" = setNames(c(1, 0, 0, 0, -1, 0), combination_names),
  "Negative_T1_vs_T3" = setNames(c(0, 0, 1, 0, -1, 0), combination_names),
  
  # Comparisons within Positive
  
  "Positive_T2_vs_T1" = setNames(c(0, 1, 0, -1, 0, 0), combination_names),
  "Positive_T2_vs_T3" = setNames(c(0, 1, 0, 0, 0, -1), combination_names),
  "Positive_T1_vs_T3" = setNames(c(0, 0, 0, 1, 0, -1), combination_names),
  
  # Comparisons between Negative and Positive
  
  "T2_Negative_vs_Positive" = setNames(c(1, -1, 0, 0, 0, 0), combination_names),
  "T1_Negative_vs_Positive" = setNames(c(0, 0, 1, -1, 0, 0), combination_names),
  "T3_Negative_vs_Positive" = setNames(c(0, 0, 0, 0, 1, -1), combination_names)
)

contrast_list
```

Estimate and apply corrections for MVA85A priming. Only significant differences within group over time.
```{r}

emm2.1 = emmeans(AM_2.1, ~ QFT * Time)
emm2.2 = emmeans(AM_2.2, ~ QFT * Time)
emm2.3 = emmeans(AM_2.3, ~ QFT * Time)
emm2.4 = emmeans(AM_2.4, ~ QFT * Time)
emm2.5 = emmeans(AM_2.5, ~ QFT * Time)
emm2.6 = emmeans(AM_2.6, ~ QFT * Time)
emm2.7 = emmeans(AM_2.7, ~ QFT * Time)
emm2.8 = emmeans(AM_2.8, ~ QFT * Time)
emm2.9 = emmeans(AM_2.9, ~ QFT * Time)
emm2.10 = emmeans(AM_2.10, ~ QFT * Time)
emm2.11 = emmeans(AM_2.11, ~ QFT * Time)

# Apply custom contrasts
contrasts1.1 = data.frame(contrast(emm2.1, method = contrast_list, adjust = "none"))
contrasts1.2 = data.frame(contrast(emm2.2, method = contrast_list, adjust = "none"))
contrasts1.3 = data.frame(contrast(emm2.3, method = contrast_list, adjust = "none"))
contrasts1.4 = data.frame(contrast(emm2.4, method = contrast_list, adjust = "none"))
contrasts1.5 = data.frame(contrast(emm2.5, method = contrast_list, adjust = "none"))
contrasts1.6 = data.frame(contrast(emm2.6, method = contrast_list, adjust = "none"))
contrasts1.7 = data.frame(contrast(emm2.7, method = contrast_list, adjust = "none"))
contrasts1.8 = data.frame(contrast(emm2.8, method = contrast_list, adjust = "none"))
contrasts1.9 = data.frame(contrast(emm2.9, method = contrast_list, adjust = "none"))
contrasts1.10 = data.frame(contrast(emm2.10, method = contrast_list, adjust = "none"))
contrasts1.11 = data.frame(contrast(emm2.11, method = contrast_list, adjust = "none"))

contrasts1.1$Outcome = v2.1
contrasts1.2$Outcome = v2.2
contrasts1.3$Outcome = v2.3
contrasts1.4$Outcome = v2.4
contrasts1.5$Outcome = v2.5
contrasts1.6$Outcome = v2.6
contrasts1.7$Outcome = v2.7
contrasts1.8$Outcome = v2.8
contrasts1.9$Outcome = v2.9
contrasts1.10$Outcome = v2.10
contrasts1.11$Outcome = v2.11

qftpcares = rbind(contrasts1.1, contrasts1.2, contrasts1.3, contrasts1.4,
                  contrasts1.5, contrasts1.6, contrasts1.7, contrasts1.8, contrasts1.9,
                  contrasts1.10, contrasts1.11)
qftpcares = qftpcares %>% arrange(p.value)

qftpcares$BH = p.adjust(qftpcares$p.value, method = "BH", n = length(qftpcares$p.value))
qftpcares$BY = p.adjust(qftpcares$p.value, method = "BY", n = length(qftpcares$p.value))

qftpcares$expestimate = exp(qftpcares$estimate)

qftpcares %>% filter(BH < 0.06) %>% filter(Outcome == v2.1)

qftpcares %>% filter(BH < 0.06) %>% filter(Outcome == v2.2)

qftpcares %>% filter(BH < 0.06) %>% filter(Outcome == v2.3)

qftpcares %>% filter(BH < 0.06) %>% filter(Outcome == v2.4)

qftpcares %>% filter(BH < 0.06) %>% filter(Outcome == v2.5)

qftpcares %>% filter(BH < 0.06) %>% filter(Outcome == v2.6)

qftpcares %>% filter(BH < 0.06) %>% filter(Outcome == v2.7)

qftpcares %>% filter(BH < 0.06) %>% filter(Outcome == v2.8)

qftpcares %>% filter(BH < 0.06) %>% filter(Outcome == v2.9)

qftpcares %>% filter(BH < 0.06) %>% filter(Outcome == v2.10)

qftpcares %>% filter(BH < 0.06) %>% filter(Outcome == v2.11)

```